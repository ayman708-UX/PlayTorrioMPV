name: Build PlayTorrioMPV

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download mpv
        shell: pwsh
        run: |
          $releases = Invoke-RestMethod "https://api.github.com/repos/shinchiro/mpv-winbuild-cmake/releases/latest"
          $asset = $releases.assets | Where-Object { $_.name -match "mpv-x86_64.*7z$" } | Select-Object -First 1
          if ($asset) {
            Write-Host "Downloading: $($asset.browser_download_url)"
            Invoke-WebRequest -Uri $asset.browser_download_url -OutFile mpv.7z
          } else {
            Write-Host "Using fallback URL"
            Invoke-WebRequest -Uri "https://sourceforge.net/projects/mpv-player-windows/files/64bit-v3/mpv-x86_64-v3-20241215-git-bfef6f2.7z/download" -OutFile mpv.7z -UserAgent "Mozilla/5.0"
          }
          7z x mpv.7z -ompv-extract -y
          
      - name: Bundle package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path PlayTorrioMPV
          $mpvExe = Get-ChildItem -Path mpv-extract -Recurse -Filter "mpv.exe" | Select-Object -First 1
          if ($mpvExe) {
            Copy-Item $mpvExe.FullName -Destination PlayTorrioMPV/
          } else {
            Write-Error "mpv.exe not found!"
            exit 1
          }
          Copy-Item -Recurse portable_config PlayTorrioMPV/
          Copy-Item playtpm.cmd PlayTorrioMPV/
          
      - name: Create archive
        shell: pwsh
        run: Compress-Archive -Path PlayTorrioMPV -DestinationPath PlayTorrioMPV-Windows-x64.zip
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: PlayTorrioMPV-Windows-x64
          path: PlayTorrioMPV-Windows-x64.zip

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Download mpv AppImage
        run: |
          ASSET_URL=$(curl -s https://api.github.com/repos/ivan-hc/MPV-appimage/releases/tags/continuous | grep -o '"browser_download_url": "[^"]*x86_64[^"]*AppImage"' | head -1 | cut -d'"' -f4)
          echo "Downloading: $ASSET_URL"
          curl -L "$ASSET_URL" -o mpv.AppImage
          chmod +x mpv.AppImage
          ls -la mpv.AppImage
          
      - name: Bundle package
        run: |
          mkdir -p PlayTorrioMPV
          cp mpv.AppImage PlayTorrioMPV/mpv
          chmod +x PlayTorrioMPV/mpv
          cp -r portable_config PlayTorrioMPV/
          cp playtpm PlayTorrioMPV/
          chmod +x PlayTorrioMPV/playtpm
          
      - name: Create archive
        run: tar -czvf PlayTorrioMPV-Linux-x64.tar.gz PlayTorrioMPV
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: PlayTorrioMPV-Linux-x64
          path: PlayTorrioMPV-Linux-x64.tar.gz

  build-macos-intel:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      
      - name: Download mpv.app
        run: |
          curl -L "https://laboratory.stolendata.net/~djinn/mpv_osx/mpv-latest.tar.gz" -o mpv.tar.gz
          tar -xzf mpv.tar.gz
          ls -la
          
      - name: Bundle package
        run: |
          mkdir -p PlayTorrioMPV
          APP_BUNDLE=$(find . -maxdepth 1 -name "*.app" -type d | head -1)
          if [ -n "$APP_BUNDLE" ]; then
            cp -R "$APP_BUNDLE" PlayTorrioMPV/mpv.app
          else
            echo "No .app bundle found!"
            exit 1
          fi
          cp -r portable_config PlayTorrioMPV/
          cp playtpm PlayTorrioMPV/
          chmod +x PlayTorrioMPV/playtpm
          
      - name: Create archive
        run: zip -r PlayTorrioMPV-macOS-Intel.zip PlayTorrioMPV
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: PlayTorrioMPV-macOS-Intel
          path: PlayTorrioMPV-macOS-Intel.zip

  build-macos-arm:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Download mpv.app
        run: |
          curl -L "https://laboratory.stolendata.net/~djinn/mpv_osx/mpv-arm64-latest.tar.gz" -o mpv.tar.gz
          tar -xzf mpv.tar.gz
          ls -la
          
      - name: Bundle package
        run: |
          mkdir -p PlayTorrioMPV
          APP_BUNDLE=$(find . -name "*.app" -type d | head -1)
          if [ -n "$APP_BUNDLE" ]; then
            echo "Found: $APP_BUNDLE"
            cp -R "$APP_BUNDLE" PlayTorrioMPV/mpv.app
          else
            echo "No .app bundle found!"
            exit 1
          fi
          cp -r portable_config PlayTorrioMPV/
          cp playtpm PlayTorrioMPV/
          chmod +x PlayTorrioMPV/playtpm
          
      - name: Create archive
        run: zip -r PlayTorrioMPV-macOS-ARM.zip PlayTorrioMPV
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: PlayTorrioMPV-macOS-ARM
          path: PlayTorrioMPV-macOS-ARM.zip

  release:
    needs: [build-windows, build-linux, build-macos-intel, build-macos-arm]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            PlayTorrioMPV-Windows-x64/PlayTorrioMPV-Windows-x64.zip
            PlayTorrioMPV-Linux-x64/PlayTorrioMPV-Linux-x64.tar.gz
            PlayTorrioMPV-macOS-Intel/PlayTorrioMPV-macOS-Intel.zip
            PlayTorrioMPV-macOS-ARM/PlayTorrioMPV-macOS-ARM.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
